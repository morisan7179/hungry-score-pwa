import React, { useState, useEffect } from "react";

export default function HomePage() {
  // âœ… æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’çµ±ä¸€ã™ã‚‹é–¢æ•°
  const getTodayDate = () =>
    new Date().toLocaleDateString("ja-JP", {
      timeZone: "Asia/Tokyo",
      year: "numeric",
      month: "2-digit",
      day: "2-digit",
    });

  // ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆç”¨
  const [theme, setTheme] = useState(() => {
    return localStorage.getItem("theme") || "light";
  });

  useEffect(() => {
    localStorage.setItem("theme", theme);
  }, [theme]);

  const isDark = theme === "dark";

  const [goal, setGoal] = useState(() => {
    const savedGoal = localStorage.getItem("goal");
    return savedGoal ? Number(savedGoal) : 300;
  });

  const [scores, setScores] = useState(() => {
    const saved = localStorage.getItem("scores");
    return saved ? JSON.parse(saved) : [];
  });

  const [total, setTotal] = useState(() => {
    const saved = localStorage.getItem("total");
    return saved ? Number(saved) : 0;
  });

  const [todayScore, setTodayScore] = useState(0); // åˆæœŸå€¤ã¯0

  useEffect(() => {
    const todayDate = getTodayDate();
    const savedDate = localStorage.getItem("lastRecordedDate");

    if (savedDate !== todayDate) {
      localStorage.setItem("lastRecordedDate", todayDate);
    }

    const todayTotal = scores
      .filter((entry) => entry.date === todayDate)
      .reduce((sum, entry) => sum + entry.score, 0);

    setTodayScore(todayTotal);

    localStorage.setItem("scores", JSON.stringify(scores));
    localStorage.setItem("goal", goal);
    localStorage.setItem("total", total);
    localStorage.setItem("todayScore", todayTotal);
  }, [scores, goal, total]);

  const addScore = (score) => {
    const now = new Date();
    const dateStr = getTodayDate();
    const timeStr = now.toLocaleTimeString("ja-JP", {
      timeZone: "Asia/Tokyo",
      hour: "2-digit",
      minute: "2-digit",
    });
    const newEntry = {
      time: timeStr,
      score,
      date: dateStr,
    };
    const newScores = [...scores, newEntry];
    setScores(newScores);
    setTotal(total + score);
  };

  const deleteScore = (realIndex) => {
    const newScores = [...scores];
    newScores.splice(realIndex, 1);
    setScores(newScores);
    setTotal(newScores.reduce((sum, entry) => sum + entry.score, 0));
  };

  const appStyle = {
    backgroundColor: isDark ? "#222" : "#fff",
    color: isDark ? "#fff" : "#000",
    minHeight: "100vh",
    transition: "background-color 0.3s, color 0.3s",
    padding: "5vw",
    paddingBottom: "25vh",
  };

  const buttonStyle = {
    fontSize: "6vw",
    padding: "2vw 4vw",
    backgroundColor: isDark ? "#444" : "#eee",
    color: isDark ? "#fff" : "#000",
    border: "1px solid #ccc",
  };

  return (
    <div style={appStyle}>
      {/* ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ */}
      <div style={{ textAlign: "right", marginBottom: "2vw" }}>
        <button
          onClick={() => setTheme(isDark ? "light" : "dark")}
          style={{
            fontSize: "5vw",
            background: "transparent",
            border: "none",
            cursor: "pointer",
          }}
        >
          {isDark ? "ğŸŒ" : "ğŸŒ™"}
        </button>
      </div>

      <h1 style={{ fontSize: "6vw", textAlign: "center" }}>
        ç©ºè…¹ã‚¹ã‚³ã‚¢ãƒ»ãƒ€ã‚¤ã‚¨ãƒƒãƒˆ
      </h1>
      <p style={{ textAlign: "center", fontSize: "4vw" }}>
        ä»Šæ—¥ã®ã‚¹ã‚³ã‚¢: {todayScore} / <strong>{goal}</strong> ç‚¹ç›®æ¨™
      </p>

      {/* æœˆé–“ç›®æ¨™å¤‰æ›´æ¬„ */}
      <div style={{ textAlign: "center", marginTop: "4vw" }}>
        <label style={{ fontSize: "3.5vw", marginRight: "2vw" }}>
          æœˆé–“ç›®æ¨™ã‚’å¤‰æ›´ï¼š
        </label>
        <input
          type="number"
          value={goal}
          onChange={(e) => setGoal(Number(e.target.value))}
          style={{
            fontSize: "3.5vw",
            width: "20vw",
            padding: "0.5vw",
            textAlign: "center",
          }}
        />
      </div>

      {/* ãƒ­ã‚°è¡¨ç¤º */}
      <div style={{ fontSize: "3.5vw", marginTop: "5vw" }}>
        <h2>è¨˜éŒ²ãƒ­ã‚°</h2>
        {scores.length === 0 ? (
          <p>ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
        ) : (
          <ul>
            {scores
              .slice()
              .reverse()
              .map((entry, index) => {
                const realIndex = scores.length - 1 - index;
                return (
                  <li
                    key={index}
                    style={{
                      display: "flex",
                      justifyContent: "space-between",
                      alignItems: "center",
                      marginBottom: "1vw",
                    }}
                  >
                    <span>
                      {entry.date} {entry.time}ï¼š{entry.score} ç‚¹
                    </span>
                    <button
                      onClick={() => deleteScore(realIndex)}
                      style={{
                        marginLeft: "2vw",
                        fontSize: "3.5vw",
                        color: "red",
                        background: "transparent",
                        border: "none",
                        cursor: "pointer",
                      }}
                    >
                      ğŸ—‘ï¸
                    </button>
                  </li>
                );
              })}
          </ul>
        )}
      </div>

      {/* â˜… ãƒœã‚¿ãƒ³ï¼ˆç”»é¢ä¸‹éƒ¨ã«å›ºå®šï¼‰ */}
      <div
        className="floating-buttons"
        style={{
          position: "fixed",
          bottom: 0,
          width: "100%",
          backgroundColor: isDark ? "#111" : "#fff",
          display: "flex",
          justifyContent: "space-around",
          padding: "3vw 0",
          boxShadow: "0 -2px 5px rgba(0,0,0,0.1)",
        }}
      >
        <button onClick={() => addScore(1)} style={buttonStyle}>
          â˜…â˜†â˜†
        </button>
        <button onClick={() => addScore(2)} style={buttonStyle}>
          â˜…â˜…â˜†
        </button>
        <button onClick={() => addScore(3)} style={buttonStyle}>
          â˜…â˜…â˜…
        </button>
      </div>
    </div>
  );
}
